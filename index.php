<?php

// Function to generate weak session ID with an incrementing value
function generateWeakSessionId() {
    $counterFile = 'session_counter.txt';

    // Initialize the counter if not exists
    if (!file_exists($counterFile)) {
        file_put_contents($counterFile, 1);
    }

    // Read the counter value
    $counter = (int)file_get_contents($counterFile);

    // Increment the counter
    $counter++;

    // Write the updated counter value
    file_put_contents($counterFile, $counter);

    return 'weak-' . $counter;
}

// Set the custom session ID handler
$id = generateWeakSessionId();

session_id($id);

session_start();

$users = [
    ['id' => 1, 'username' => 'user1', 'password' => 'password1'],
    ['id' => 2, 'username' => 'user2', 'password' => 'password2'],
    ['id' => 3, 'username' => 'user3', 'password' => 'password3'],
    ['id' => 4, 'username' => 'user4', 'password' => 'password4'],
    ['id' => 5, 'username' => 'user5', 'password' => 'password5'],
    ['id' => 6, 'username' => 'user6', 'password' => 'password6'],
    ['id' => 7, 'username' => 'user7', 'password' => 'password7'],
    ['id' => 8, 'username' => 'user8', 'password' => 'password8'],
    ['id' => 9, 'username' => 'user9', 'password' => 'password9'],
    ['id' => 10, 'username' => 'user10', 'password' => 'password10']
];

$message = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_POST['login'])) {
        // Handle login
        $username = $_POST['username'];
        $password = $_POST['password'];

        // Perform login logic
        $user = array_filter($users, function ($u) use ($username, $password) {
            return $u['username'] === $username && $u['password'] === $password;
        });

        if ($user) {
            session_destroy();
            $id = generateWeakSessionId();
            session_id($id);
            session_start();

            // User found, set the session
            $user = array_values($user)[0];
            $_SESSION['user'] = $user;

            $message = 'Login successful';
        } else {
            // User not found
            $message = 'Login failed';
        }
    }
}elseif ($_SERVER['REQUEST_METHOD'] === 'GET'){ 
    if (isset($_GET['logout'])) {
        // Handle logout
        // Perform logout logic (clear session data)
        $_SESSION = [];
        session_destroy();
        $message = 'Logout successful';
    } elseif (isset($_GET['protected'])) {
        // Handle protected resource request
        // Perform authentication logic
        if (isset($_SESSION['user'])) {
            $message = 'You have access to the protected resource' . $_SESSION['user'];
        } else {
            $message = 'Access denied';
        }
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Example</title>
</head>
<body>
    <h1>Authentication Example</h1>
    
    <form method="post">
        <div>
            <label for="username">Username: </label>
            <input type="text" name="username" id="username" required>
        </div>
        <div>
            <label for="password">Password: </label>
            <input type="password" name="password" id="password" required>
        </div>
        <div>
            <button type="submit" name="login">Login</button>
        </div>
    </form>
    <div>
        <a href="?logout">Logout</a>
        <a href="?protected">Access Protected Resource</a>
    </div>
    <div>
        <p><?php echo $message; ?></p>
    </div>
</body>
</html>