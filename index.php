<?php
session_start();

// Simple "database" array with user information
$users = [
    ['user_id' => 1, 'username' => 'user1', 'password' => 'pass1'],
    ['user_id' => 2, 'username' => 'user2', 'password' => 'pass2'],
    ['user_id' => 3, 'username' => 'user3', 'password' => 'pass3']
];

// Function to find a user by username
function findUserByUsername($username) {
    global $users;
    foreach ($users as $user) {
        if ($user['username'] === $username) {
            return $user;
        }
    }
    return null;
}

// Function to authenticate the user
function authenticateUser($username, $password) {
    $user = findUserByUsername($username);
    return ($user !== null && $user['password'] === $password);
}

// Function to change user password
function changePassword($username, $newPassword) {
    $user = findUserByUsername($username);
    if ($user !== nuxll) {
        $user['password'] = $newPassword;
        return true;
    }
    return false;
}

// Handle login
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['login'])) {
    $username = $_POST['username'];
    $password = $_POST['password'];

    if (authenticateUser($username, $password)) {
        session_regenerate_id();

        $_SESSION['username'] = $username;

    } else {
        $loginError = "Invalid username or password";
    }
}

// Handle change password
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['change_password'])) {
    $username = $_SESSION['username'];
    $oldPassword = $_POST['old_password'];
    $newPassword = $_POST['new_password'];

    if (authenticateUser($username, $oldPassword)) {
        // Change password
        changePassword($username, $newPassword);
        $passwordChangeMessage = "Password changed successfully";
    } else {
        $changePasswordError = "Incorrect old password";
    }
}

// Handle logout
if (isset($_GET['logout'])) {
    // Clear the session and cookie on logout
    session_unset();
    session_destroy();
    header("Location: ".$_SERVER['PHP_SELF']);
    exit;
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHP Session Example</title>
</head>
<body>

<?php if (isset($_SESSION['username'])): ?>
    <p>Welcome, <?php echo $_SESSION['username']; ?>! <a href='<?php echo $_SERVER['PHP_SELF']; ?>?logout=1'>Logout</a></p>

    <!-- Display change password form -->
    <form method="post" action="<?php echo $_SERVER['PHP_SELF']; ?>">
        <h2>Change Password</h2>
        <?php if (isset($changePasswordError)): ?>
            <p><?php echo $changePasswordError; ?></p>
        <?php endif; ?>
        <?php if (isset($passwordChangeMessage)): ?>
            <p><?php echo $passwordChangeMessage; ?></p>
        <?php endif; ?>
        <label for="old_password">Old Password:</label>
        <input type="password" name="old_password" required><br>
        <label for="new_password">New Password:</label>
        <input type="password" name="new_password" required><br>
        <input type="submit" name="change_password" value="Change Password">
    </form>

    <!-- Protected Profile button -->
    <button onclick="window.location.href='protected_profile.php'">Protected Profile</button>

<?php else: ?>
    <!-- Display login form -->
    <form method="post" action="<?php echo $_SERVER['PHP_SELF']; ?>">
        <?php if (isset($loginError)): ?>
            <p><?php echo $loginError; ?></p>
        <?php endif; ?>
        <label for="username">Username:</label>
        <input type="text" name="username" required><br>
        <label for="password">Password:</label>
        <input type="password" name="password" required><br>
        <input type="submit" name="login" value="Login">
    </form>
<?php endif; ?>

</body>
</html>